<?php
/* =========================
   DINGIN FM â€” TEK PARÃ‡A
   Admin + Ä°statistik
   ========================= */

header('X-Frame-Options: DENY');
header('X-Content-Type-Options: nosniff');

$db=new PDO(
  "mysql:host=localhost;dbname=dinginfm;charset=utf8mb4",
  "dinginfm_user",
  "STRONG_PASSWORD",
  [
    PDO::ATTR_ERRMODE=>PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE=>PDO::FETCH_ASSOC
  ]
);

/* TABLO */
$db->exec("
CREATE TABLE IF NOT EXISTS listener_stats(
  id INT AUTO_INCREMENT PRIMARY KEY,
  recorded_at DATETIME NOT NULL,
  listeners INT NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
");

/* ICECAST OKUMA */
function getListeners(){
  $j=@file_get_contents("https://dinginfm.com.tr:8000/status-json.xsl");
  if(!$j) return null;
  $d=json_decode($j,true);
  if(!isset($d['icestats']['source'])) return 0;
  $s=$d['icestats']['source'];
  return isset($s[0])?(int)$s[0]['listeners']:(int)($s['listeners']??0);
}

/* CRON TETÄ°K (CLI) */
if(PHP_SAPI==='cli'){
  $l=getListeners();
  if($l!==null){
    $db->prepare("
      INSERT INTO listener_stats(recorded_at,listeners)
      VALUES(NOW(),?)
    ")->execute([$l]);
  }
  exit;
}

/* Ä°STATÄ°STÄ°K */
$today=$db->query("
  SELECT AVG(listeners) avg_l, MAX(listeners) max_l
  FROM listener_stats
  WHERE DATE(recorded_at)=CURDATE()
")->fetch();

$week=$db->query("
  SELECT AVG(listeners) avg_l, MAX(listeners) max_l
  FROM listener_stats
  WHERE recorded_at>=NOW()-INTERVAL 7 DAY
")->fetch();

$month=$db->query("
  SELECT AVG(listeners) avg_l, MAX(listeners) max_l
  FROM listener_stats
  WHERE recorded_at>=NOW()-INTERVAL 30 DAY
")->fetch();

$now=getListeners();
?>
<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="robots" content="noindex,nofollow">
<title>YÃ¶netim Paneli</title>

<style>
/* ======================
   DINGIN FM â€” ADMIN UI
   (Logo fixed + iÃ§erik aÅŸaÄŸÄ±)
   ====================== */

:root{
  --headerH: 86px; /* logo alanÄ± yÃ¼ksekliÄŸi */
  --cardMax: 720px;
}

*{box-sizing:border-box}
html,body{height:100%;margin:0}

body{
  font-family: "Segoe UI", Arial, sans-serif;
  background:#eef4fb;
  color:#355;
}

/* âœ… LOGO ÃœST KATMAN (SABÄ°T) */
.fm-header{
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: var(--headerH);
  z-index: 9999;
  display:flex;
  align-items:center;
  padding: 10px 18px;
  background: transparent; /* admin sayfasÄ± sade kalsÄ±n */
}

/* Logo */
.fm-header .brand{
  display:flex;
  align-items:center;
  gap:12px;
  text-decoration:none;
}

.fm-header img{
  height: 54px;
  width: auto;
  display:block;
}

/* âœ… SAYFA LOGOYA GÃ–MÃœLMESÄ°N */
.fm-main{
  padding-top: var(--headerH);
}

/* Kart */
.box{
  max-width: var(--cardMax);
  margin: 24px auto;
  background:#fff;
  padding:24px;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.12);
}

h1{margin:0 0 10px}
.stat{font-size:18px;margin:6px 0}
small{color:#789}

hr{
  border:0;
  height:1px;
  background: rgba(0,0,0,.08);
  margin: 16px 0;
}
</style>

</head>
<body>

<!-- âœ… SABÄ°T LOGO -->
<header class="fm-header">
  <a class="brand" href="/" title="Dingin FM">
    <img src="logo.png" alt="Dingin FM">
  </a>
</header>

<main class="fm-main">
  <div class="box">
    <h1>YÃ¶netim Paneli</h1>

    <div class="stat">ðŸŽ§ AnlÄ±k Dinleyici: <strong><?= (int)$now ?></strong></div>

    <hr>

    <div class="stat">
      BugÃ¼n â€” Ort: <strong><?=round($today['avg_l']??0,1)?></strong>
      | Max: <strong><?= (int)($today['max_l']??0) ?></strong>
    </div>

    <div class="stat">
      Son 7 GÃ¼n â€” Ort: <strong><?=round($week['avg_l']??0,1)?></strong>
      | Max: <strong><?= (int)($week['max_l']??0) ?></strong>
    </div>

    <div class="stat">
      Son 30 GÃ¼n â€” Ort: <strong><?=round($month['avg_l']??0,1)?></strong>
      | Max: <strong><?= (int)($month['max_l']??0) ?></strong>
    </div>

    <small>Bu veriler sadece admin iÃ§indir.</small>
  </div>
</main>

</body>
</html>
