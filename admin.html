<?php
$db = new PDO(
  "mysql:host=localhost;dbname=dinginfm;charset=utf8mb4",
  "dinginfm_user",
  "STRONG_PASSWORD",
  [
    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
  ]
);

$db->exec("
CREATE TABLE IF NOT EXISTS messages(
  id INT AUTO_INCREMENT PRIMARY KEY,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  name VARCHAR(120) NOT NULL,
  email VARCHAR(180),
  message TEXT NOT NULL,
  ip VARCHAR(45) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
");

if($_SERVER["REQUEST_METHOD"]==="POST"){
  $name=trim($_POST["name"]??"");
  $email=trim($_POST["email"]??"");
  $message=trim($_POST["message"]??"");

  if($name===""||$message===""||mb_strlen($message)<3){
    http_response_code(400);
    exit("INVALID");
  }

  $db->prepare("
    INSERT INTO messages(name,email,message,ip)
    VALUES(?,?,?,?)
  ")->execute([
    $name,$email,$message,$_SERVER["REMOTE_ADDR"]
  ]);
  exit("OK");
}

$messages=$db->query("
  SELECT * FROM messages ORDER BY id DESC
")->fetchAll();

$listenerCount=0;
$icecast=@file_get_contents("https://dinginfm.com.tr:8000/status-json.xsl");
if($icecast){
  $data=json_decode($icecast,true);
  if(isset($data["icestats"]["source"])){
    $s=$data["icestats"]["source"];
    $listenerCount=isset($s[0])?(int)$s[0]["listeners"]:(int)($s["listeners"]??0);
  }
}
?>
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>DINGIN FM â€” ADMIN</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex,nofollow">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Segoe UI,Arial,sans-serif;
  background:#eef6ff;
  color:#123;
}

/* === TAM SAYFA LOGO === */
.hero{
  min-height:100vh;
  background:
    radial-gradient(circle at center, rgba(255,255,255,.85), rgba(238,246,255,.95)),
    url("/assets/dinginfm-logo.png") center center no-repeat;
  background-size:contain;
  display:flex;
  align-items:flex-end;
  padding:40px;
}

/* === STAT BAR === */
.statbar{
  background:#ffffffee;
  padding:18px 28px;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.18);
  font-size:22px;
  color:#2b7a4b;
}

/* === PANEL === */
main{
  max-width:1200px;
  margin:60px auto;
  background:#fff;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.18);
  padding:24px;
}

table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:12px 10px;
  border-bottom:1px solid #dde6f0;
  text-align:left;
  vertical-align:top;
}
th{
  background:#f3f8ff;
  font-weight:600;
}
tr:hover{
  background:#f9fcff;
}
td.message{
  white-space:pre-wrap;
  max-width:520px;
}
small{color:#789}
</style>
</head>

<body>

<section class="hero">
  <div class="statbar">
    ðŸŽ§ AnlÄ±k Dinleyici: <strong><?= $listenerCount ?></strong>
  </div>
</section>

<main>
<table>
<tr>
  <th>Tarih</th>
  <th>Ad</th>
  <th>Email</th>
  <th>Mesaj</th>
  <th>IP</th>
</tr>

<?php if(!$messages): ?>
<tr><td colspan="5"><small>HenÃ¼z mesaj yok.</small></td></tr>
<?php endif; ?>

<?php foreach($messages as $m): ?>
<tr>
  <td><?=htmlspecialchars($m["created_at"])?></td>
  <td><?=htmlspecialchars($m["name"])?></td>
  <td><?=htmlspecialchars($m["email"])?></td>
  <td class="message"><?=nl2br(htmlspecialchars($m["message"]))?></td>
  <td><?=htmlspecialchars($m["ip"])?></td>
</tr>
<?php endforeach; ?>
</table>
</main>

</body>
</html>
