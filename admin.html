<?php
/* ===== DINGIN FM â€” GERÃ‡EK ADMIN PANEL =====
   DEMO YOK
   GERÃ‡EK MESAJ + GERÃ‡EK DÄ°NLEYÄ°CÄ°
========================================== */

/* === DB AYAR === */
$db = new PDO(
  "mysql:host=localhost;dbname=dinginfm;charset=utf8mb4",
  "dinginfm_user",
  "STRONG_PASSWORD",
  [PDO::ATTR_ERRMODE=>PDO::ERRMODE_EXCEPTION]
);

/* === TABLO === */
$db->exec("
CREATE TABLE IF NOT EXISTS messages(
  id INT AUTO_INCREMENT PRIMARY KEY,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  name VARCHAR(120),
  email VARCHAR(180),
  message TEXT,
  ip VARCHAR(45)
)
");

/* === MESAJ KAYIT === */
if($_SERVER["REQUEST_METHOD"]==="POST"){
  $db->prepare("
    INSERT INTO messages(name,email,message,ip)
    VALUES(?,?,?,?)
  ")->execute([
    $_POST["name"],
    $_POST["email"],
    $_POST["message"],
    $_SERVER["REMOTE_ADDR"]
  ]);
  exit("OK");
}

/* === MESAJLAR === */
$messages = $db->query("
  SELECT * FROM messages ORDER BY id DESC
")->fetchAll(PDO::FETCH_ASSOC);

/* === GERÃ‡EK DÄ°NLEYÄ°CÄ° (ICECAST) === */
$listenerCount = 0;
$icecast = @file_get_contents("https://dinginfm.com.tr:8000/status-json.xsl");

if($icecast){
  $data = json_decode($icecast,true);
  if(isset($data["icestats"]["source"])){
    $src = $data["icestats"]["source"];
    $listenerCount = isset($src["listeners"]) ? $src["listeners"] : 0;
  }
}
?>
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Dingin FM â€” Admin</title>
<style>
body{margin:0;font-family:Segoe UI;background:#eef6ff}
header{padding:20px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.15)}
main{max-width:1100px;margin:40px auto;background:#fff;
border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.18);padding:24px}
.stat{font-size:22px;margin-bottom:20px;color:#2b5}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #dde}
th{background:#f4faff}
</style>
</head>

<body>

<header>
  <h1>DINGIN FM â€” ADMIN</h1>
  <div class="stat">ðŸŽ§ AnlÄ±k Dinleyici: <b><?= $listenerCount ?></b></div>
</header>

<main>
<table>
<tr>
  <th>Tarih</th><th>Ad</th><th>Email</th><th>Mesaj</th><th>IP</th>
</tr>
<?php foreach($messages as $m): ?>
<tr>
<td><?=htmlspecialchars($m["created_at"])?></td>
<td><?=htmlspecialchars($m["name"])?></td>
<td><?=htmlspecialchars($m["email"])?></td>
<td><?=nl2br(htmlspecialchars($m["message"]))?></td>
<td><?=htmlspecialchars($m["ip"])?></td>
</tr>
<?php endforeach; ?>
</table>
</main>

</body>
</html>
