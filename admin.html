<?php
header('X-Frame-Options: DENY');
header('X-Content-Type-Options: nosniff');

$db=new PDO(
  "mysql:host=localhost;dbname=dinginfm;charset=utf8mb4",
  "dinginfm_user",
  "STRONG_PASSWORD",
  [
    PDO::ATTR_ERRMODE=>PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE=>PDO::FETCH_ASSOC
  ]
);

$db->exec("
CREATE TABLE IF NOT EXISTS listener_stats(
  id INT AUTO_INCREMENT PRIMARY KEY,
  recorded_at DATETIME NOT NULL,
  listeners INT NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
");

function getListeners(){
  $url="http://127.0.0.1:8000/status-json.xsl";
  $ctx=stream_context_create(['http'=>['timeout'=>3]]);
  $j=@file_get_contents($url,false,$ctx);
  if(!$j) return null;
  $d=json_decode($j,true);
  if(!isset($d['icestats']['source'])) return 0;
  $s=$d['icestats']['source'];
  return isset($s[0]) ? (int)$s[0]['listeners'] : (int)($s['listeners'] ?? 0);
}

if(PHP_SAPI==='cli'){
  $l=getListeners();
  if($l!==null){
    $db->prepare("
      INSERT INTO listener_stats(recorded_at,listeners)
      VALUES(NOW(),?)
    ")->execute([$l]);
  }
  exit;
}

$today=$db->query("
  SELECT AVG(listeners) avg_l, MAX(listeners) max_l
  FROM listener_stats
  WHERE DATE(recorded_at)=CURDATE()
")->fetch();

$week=$db->query("
  SELECT AVG(listeners) avg_l, MAX(listeners) max_l
  FROM listener_stats
  WHERE recorded_at>=NOW()-INTERVAL 7 DAY
")->fetch();

$month=$db->query("
  SELECT AVG(listeners) avg_l, MAX(listeners) max_l
  FROM listener_stats
  WHERE recorded_at>=NOW()-INTERVAL 30 DAY
")->fetch();

$now=getListeners();
?>
<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="robots" content="noindex,nofollow">
<title>Admin Panel</title>

<style>
*{box-sizing:border-box}
html,body{height:100%;margin:0}

:root{
  --fm-title:#6fc9ff;
}

body{
  font-family:"Segoe UI",Arial,sans-serif;
}

/* âœ… FULL EKRAN LOGO */
body::before{
  content:"";
  position:fixed;
  inset:0;
  z-index:0;
  background:url("logo.png") center center no-repeat;
  background-size:cover;
}

/* âœ… ÃœST BAR (yazÄ± garanti okunur ama logo boÄŸulmaz) */
.topbar{
  position:fixed;
  top:0; left:0;
  width:100%;
  z-index:9999;
  padding:12px 10px;

  background:rgba(0,0,0,.28);
  backdrop-filter:blur(8px);
  -webkit-backdrop-filter:blur(8px);

  border-bottom:1px solid rgba(255,255,255,.14);
  color:#fff;
  font-weight:700;
  text-shadow:0 2px 10px rgba(0,0,0,.65);
  text-align:center;
}

/* âœ… iÃ§erik (logo kapanmasÄ±n diye kÃ¼Ã§Ã¼k panel) */
main{
  position:relative;
  z-index:1;
  padding:80px 20px 20px;
  max-width:720px;
  margin:0 auto;
}

.panel{
  background:rgba(0,0,0,.22);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;
  padding:22px 18px;
  box-shadow:0 14px 40px rgba(0,0,0,.18);
}

.stat{
  font-size:18px;
  margin:10px 0;
  color:#fff;
  text-shadow:0 2px 12px rgba(0,0,0,.65);
}

strong{color:var(--fm-title)}

hr{
  border:0;
  height:1px;
  background:rgba(255,255,255,.25);
  margin:18px 0;
}

small{
  display:block;
  margin-top:14px;
  color:rgba(255,255,255,.75);
  text-shadow:0 2px 12px rgba(0,0,0,.65);
}

/* âœ… footer sabit, logo bozulmaz */
footer{
  position:fixed;
  left:0;
  bottom:0;
  width:100%;
  padding:14px 10px;
  font-size:13px;
  color:rgba(255,255,255,.70);
  text-align:center;
  text-shadow:0 2px 12px rgba(0,0,0,.65);
  z-index:9;
}
</style>
</head>

<body>

<div class="topbar">Admin Panel</div>

<main>
  <div class="panel">

    <div class="stat">
      ðŸŽ§ AnlÄ±k Dinleyici:
      <strong><?= ($now===null ? "BaÄŸlanamadÄ±" : (int)$now) ?></strong>
    </div>

    <hr>

    <div class="stat">
      BugÃ¼n â€” Ort: <strong><?=round($today['avg_l']??0,1)?></strong>
      | Max: <strong><?= (int)($today['max_l']??0) ?></strong>
    </div>

    <div class="stat">
      Son 7 GÃ¼n â€” Ort: <strong><?=round($week['avg_l']??0,1)?></strong>
      | Max: <strong><?= (int)($week['max_l']??0) ?></strong>
    </div>

    <div class="stat">
      Son 30 GÃ¼n â€” Ort: <strong><?=round($month['avg_l']??0,1)?></strong>
      | Max: <strong><?= (int)($month['max_l']??0) ?></strong>
    </div>

    <small>Bu veriler sadece admin iÃ§indir.</small>

  </div>
</main>

<footer>
  Â© 2025 Dingin FM â€” SessizliÄŸin Sesi Burada. TÃ¼m haklarÄ± saklÄ±dÄ±r.
</footer>

</body>
</html>
