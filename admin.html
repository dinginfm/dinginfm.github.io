<?php
$db = new PDO(
  "mysql:host=localhost;dbname=dinginfm;charset=utf8mb4",
  "dinginfm_user",
  "STRONG_PASSWORD",
  [
    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
  ]
);

$db->exec("
CREATE TABLE IF NOT EXISTS messages(
  id INT AUTO_INCREMENT PRIMARY KEY,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  name VARCHAR(120) NOT NULL,
  email VARCHAR(180),
  message TEXT NOT NULL,
  ip VARCHAR(45) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
");

if($_SERVER['REQUEST_METHOD']==='POST'){
  $name=trim($_POST['name']??'');
  $email=trim($_POST['email']??'');
  $message=trim($_POST['message']??'');

  if($name===''||$message===''||mb_strlen($message)<3){
    http_response_code(400);
    exit('INVALID');
  }

  $db->prepare("
    INSERT INTO messages(name,email,message,ip)
    VALUES(?,?,?,?)
  ")->execute([
    $name,$email,$message,$_SERVER['REMOTE_ADDR']
  ]);

  exit('OK');
}

$messages=$db->query("
  SELECT * FROM messages ORDER BY id DESC
")->fetchAll();

$listenerCount=0;
$icecast=@file_get_contents("https://dinginfm.com.tr:8000/status-json.xsl");
if($icecast){
  $data=json_decode($icecast,true);
  if(isset($data['icestats']['source'])){
    $s=$data['icestats']['source'];
    $listenerCount=isset($s[0])?(int)$s[0]['listeners']:(int)($s['listeners']??0);
  }
}
?>
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>DINGIN FM â€” ADMIN</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex,nofollow">

<style>
*{box-sizing:border-box}

:root{
  --fm-title:#6fc9ff;
  --fm-soft:#9fdcff;
  --fm-text:#4a6f8a;
}

html,body{
  margin:0;
  height:100%;
}

body{
  font-family:Segoe UI,Arial,sans-serif;
  color:var(--fm-text);
  background:#eef4fb;
  position:relative;
}

/* TAM SAYFA SABÄ°T LOGO */
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:
    radial-gradient(
      circle at center,
      rgba(255,255,255,.92) 0%,
      rgba(230,240,250,.96) 45%,
      rgba(210,225,240,.98) 100%
    ),
    url("logo.png") center center no-repeat;
  background-size:contain;
  z-index:0;
}

/* ÃœST KATMAN */
header,main{
  position:relative;
  z-index:1;
}

/* HEADER */
header{
  padding:32px 20px 10px;
  text-align:center;
}

header h1{
  margin:0;
  color:var(--fm-title);
  font-size:26px;
}

.stat{
  margin-top:8px;
  color:var(--fm-soft);
  font-size:18px;
}

/* PANEL */
main{
  max-width:1200px;
  margin:60px auto 80px;
  background:rgba(255,255,255,.85);
  backdrop-filter:blur(4px);
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.18);
  padding:24px;
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:12px 10px;
  border-bottom:1px solid #dde6f0;
  text-align:left;
  vertical-align:top;
}

th{
  background:#f3f8ff;
  font-weight:600;
  color:var(--fm-title);
}

tr:hover{
  background:#f9fcff;
}

td{
  color:var(--fm-text);
}

td.message{
  white-space:pre-wrap;
  max-width:520px;
}

small{color:#789}
</style>
</head>

<body>

<header>
  <h1>DINGIN FM â€” ADMIN</h1>
  <div class="stat">ðŸŽ§ AnlÄ±k Dinleyici: <strong><?= $listenerCount ?></strong></div>
</header>

<main>
<table>
<tr>
  <th>Tarih</th>
  <th>Ad</th>
  <th>Email</th>
  <th>Mesaj</th>
  <th>IP</th>
</tr>

<?php if(!$messages): ?>
<tr><td colspan="5"><small>HenÃ¼z mesaj yok.</small></td></tr>
<?php endif; ?>

<?php foreach($messages as $m): ?>
<tr>
  <td><?=htmlspecialchars($m['created_at'])?></td>
  <td><?=htmlspecialchars($m['name'])?></td>
  <td><?=htmlspecialchars($m['email'])?></td>
  <td class="message"><?=nl2br(htmlspecialchars($m['message']))?></td>
  <td><?=htmlspecialchars($m['ip'])?></td>
</tr>
<?php endforeach; ?>

</table>
</main>

</body>
</html>
